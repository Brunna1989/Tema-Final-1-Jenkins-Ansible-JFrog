pipeline {
    agent any

    environment {
        CI = 'true'
    }

    stages {
        stage('Download JAR from JFrog') {
            steps {
                script {
                    def jfrogUrl = 'http://artifactory:8082/artifactory/tema-final-1-job-1/Tema-final-1-0.0.1-SNAPSHOT.jar'
                    def jfrogUser = 'admin'
                    def jfrogPassword = credentials('token_jfrog')

                    sh "curl -u $jfrogUser:$jfrogPassword -o app.jar $jfrogUrl"
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def packerVarFile = 'packer_vars.json'

                    sh "echo '{\"dockerhub_username\": \"\", \"dockerhub_password\": \"\", \"tomcat_dir\": \"/apache-tomcat-10.0.12/webapps/Tema-final-1-0.0.1-SNAPSHOT.jar\"}' > $packerVarFile"
                    sh "packer build -var-file=$packerVarFile packerConfigurations.json"
                }
            }
        }

        stage('Push Docker Image to Docker Hub') {
            steps {
                script {
                    def dockerhubUsername = credentials('dockerhub-credentials').USUARIO
                    def dockerhubPassword = credentials('dockerhub-credentials').SENHA
                    def imageTag = "brunnadocker/brunna-dornelles-tema-final-1:1.0"  // Defina a tag desejada

                    sh "docker login -u $dockerhubUsername -p $dockerhubPassword"
                    sh "docker tag ubuntu:20.04 $imageTag"
                    sh "docker push $imageTag"
                }
            }
        }
    }
}

